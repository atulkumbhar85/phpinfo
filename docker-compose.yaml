networks:
  phpinfo-network:
    internal: true
  volume-init-network:
    internal: false

services:
  phpinfo-service:
    command:
      - -f
      - index.php
      - -S
      - 0.0.0.0:8080
    deploy:
      mode: replicated
      placement:
        constraints:
          - node.role == worker
      replicas: 2
    entrypoint: /usr/bin/php
    environment:
      HELLO: world
      AUTHOR: Atul
    image: atulkumbhar85/phpinfo:single
    networks:
      - phpinfo-network
    ports:
      - 80:8080
    user: nobody
    volumes:
      - phpinfo-volume:/shared/:ro
    working-dir: /shared/phpinfo/src/
  volume-init-service:
    command:
      - -c
      - rm -rf phpinfo && git clone https://github.com.atulkumbhar85/phpinfo && cd phpinfo/ && sleep 1000 
    deploy:
      mode: global      
      placement:
        - node.role == worker              
    entrypoint: /bin/sh
    environment:
      HELLO: bye
    image: alpine/git:latest
    networks: 
      - volume-init-network
    user: root
    volume:
      - phpinfo-volume:/shared/:ro
    working-dir: /shared/    

version: '3.8'

volumes:
  phpinfo-volume:
